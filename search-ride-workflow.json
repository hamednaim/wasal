{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chercher-trajet",
        "responseMode": "responseNode",
        "options": {}
      },
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -544,
        32
      ],
      "id": "f6b5a58c-d197-4756-bd6c-25e07c2e8493",
      "webhookId": "2276f3b5-800b-4c4c-becd-508454c00000"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Tu es un assistant pour une app de covoiturage tunisienne.\n\nExtrait ces informations du texte de l'utilisateur :\n- departure : ville de d√©part (en fran√ßais ou arabe tunisien)\n- arrival : ville d'arriv√©e (en fran√ßais ou arabe tunisien)  \n- date : date du trajet (format yyyy-mm-dd si mentionn√©e, sinon null)\n\nRETOURNE UNIQUEMENT UN JSON VALIDE avec ces 3 cl√©s, sans aucun texte suppl√©mentaire.\n\nConvertis les variantes dialectales en noms standards :\n- tounes/tunes ‚Üí tunis\n- tozer/touzeur ‚Üí tozeur\n- soussa/sousa ‚Üí sousse\n- safakes/sfekes ‚Üí sfax\n- qabis ‚Üí gabes\n- mestir ‚Üí monastir\n- kairawan ‚Üí kairouan\n- banzart ‚Üí bizerte\n\nExemples :\n- \"n7eb nemchy mn tunis l tozer\" ‚Üí {\"departure\": \"tunis\", \"arrival\": \"tozeur\", \"date\": null}\n- \"trajet de Sfax vers Sousse demain\" ‚Üí {\"departure\": \"sfax\", \"arrival\": \"sousse\", \"date\": null}\n- \"bech nemchi mel tounes lel soussa\" ‚Üí {\"departure\": \"tunis\", \"arrival\": \"sousse\", \"date\": null}\n\nTexte utilisateur : {{$json[\"body\"][\"recherche\"]}}",
        "batching": {}
      },
      "name": "Extraire Infos LLM",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -288,
        -64
      ],
      "id": "7566cb5c-522b-49ce-817c-d86650cc9802"
    },
    {
      "parameters": {
        "jsCode": "// === PR√âPARER LES CRIT√àRES DE RECHERCHE ===\n\nconst llmText = $input.first().json.text;\nlet searchCriteria = {};\n\ntry {\n  searchCriteria = JSON.parse(llmText);\n  console.log(\"‚úÖ Crit√®res extraits:\", searchCriteria);\n} catch (error) {\n  console.log(\"‚ùå Erreur parsing:\", error.message);\n  return [{\n    json: {\n      SEARCH_ACTIVE: false,\n      message: \"Impossible de comprendre la recherche\"\n    }\n  }];\n}\n\n// V√©rifier si on a au moins un champ renseign√©\nconst hasDeparture = searchCriteria.departure && searchCriteria.departure.trim() !== '';\nconst hasArrival = searchCriteria.arrival && searchCriteria.arrival.trim() !== '';\nconst hasDate = searchCriteria.date && searchCriteria.date !== null;\n\nif (!hasDeparture && !hasArrival && !hasDate) {\n  console.log(\"‚ö†Ô∏è Aucun crit√®re valide trouv√© ‚Üí pas de recherche\");\n  return [{\n    json: {\n      SEARCH_ACTIVE: false,\n      message: \"Aucun crit√®re trouv√© dans la recherche\"\n    }\n  }];\n}\n\n// Passer les crit√®res si au moins un champ est pr√©sent\nreturn [{\n  json: {\n    SEARCH_DEPARTURE: searchCriteria.departure || '',\n    SEARCH_ARRIVAL: searchCriteria.arrival || '',\n    SEARCH_DATE: searchCriteria.date || null,\n    SEARCH_ACTIVE: true\n  }\n}];\n"
      },
      "name": "Pr√©parer Crit√®res",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        0,
        96
      ],
      "id": "9edc7ab8-159a-4bc7-9ea9-f7915c8e293c"
    },
    {
      "parameters": {
        "documentId": {
          "mode": "id",
          "value": "19yAwqC9651ZBPL4jbjsrABYUHb5URUrffJrbqR039ME"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Feuille 1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/19yAwqC9651ZBPL4jbjsrABYUHb5URUrffJrbqR039ME/edit#gid=0"
        },
        "options": {}
      },
      "name": "Lire Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        -320,
        288
      ],
      "id": "1e494039-8f19-4757-ae8f-45137375eec7",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "Gkr73XIUgrfYMg2M",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// === FILTRAGE DES TRAJETS ===\n\nconsole.log(\"\\n========== FILTRAGE DES TRAJETS ==========\");\nconsole.log(\"Nombre d'items re√ßus:\", $input.all().length);\n\n// Le premier item contient les crit√®res de recherche\nconst firstItem = $input.first().json;\nconsole.log(\"\\nPremier item (crit√®res):\", firstItem);\n\nif (!firstItem.SEARCH_ACTIVE) {\n  return [{\n    json: {\n      success: false,\n      found: false,\n      message: firstItem.message || \"Aucun crit√®re de recherche valide\"\n    }\n  }];\n}\n\n\n\n// Extraire les crit√®res de recherche\nlet searchCriteria = {\n  departure: '',\n  arrival: '',\n  date: null\n};\n\n// Chercher les crit√®res avec le pr√©fixe SEARCH_\nif (firstItem.SEARCH_ACTIVE) {\n  searchCriteria.departure = firstItem.SEARCH_DEPARTURE || '';\n  searchCriteria.arrival = firstItem.SEARCH_ARRIVAL || '';\n  searchCriteria.date = firstItem.SEARCH_DATE || null;\n  console.log(\"‚úÖ Crit√®res trouv√©s avec SEARCH_\");\n} else {\n  console.log(\"‚ùå Pas de crit√®res SEARCH_ trouv√©s, recherche abandonn√©e\");\n  return [{\n    json: {\n      success: false,\n      found: false,\n      message: \"Erreur: crit√®res de recherche non trouv√©s\"\n    }\n  }];\n}\n\nconsole.log(\"\\nüéØ Crit√®res de recherche:\");\nconsole.log(`  D√©part demand√©: \"${searchCriteria.departure}\"`);\nconsole.log(`  Arriv√©e demand√©e: \"${searchCriteria.arrival}\"`);\nconsole.log(`  Date: ${searchCriteria.date || 'non sp√©cifi√©e'}`);\n\n// R√©cup√©rer tous les trajets (en excluant le premier item qui contient les crit√®res)\nconst allRides = $input.all().slice(1);\nconsole.log(`\\nüìä Nombre de trajets √† analyser: ${allRides.length}`);\n\nif (allRides.length === 0) {\n  return [{\n    json: {\n      success: false,\n      found: false,\n      message: \"Aucun trajet dans la base de donn√©es\"\n    }\n  }];\n}\n\n// Fonction de normalisation\nfunction normalizeCity(city) {\n  if (!city) return '';\n  return String(city)\n    .toLowerCase()\n    .trim()\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '') // Enlever accents\n    .replace(/[-_\\s]+/g, '') // Enlever espaces\n    .replace(/[^a-z0-9]/g, ''); // Garder lettres/chiffres\n}\n\n// Fonction de comparaison de villes\nfunction citiesMatch(rideCity, searchCity) {\n  // Si pas de crit√®re de recherche, on ne filtre pas sur ce champ\n  if (!searchCity || searchCity === '') {\n    console.log(`      ‚Üí Pas de filtre sur ce champ`);\n    return true;\n  }\n  \n  // Si la ville du trajet est vide, pas de match\n  if (!rideCity) {\n    console.log(`      ‚Üí Ville du trajet vide = pas de match`);\n    return false;\n  }\n  \n  const norm1 = normalizeCity(rideCity);\n  const norm2 = normalizeCity(searchCity);\n  \n  console.log(`      Comparaison: \"${norm1}\" vs \"${norm2}\"`);\n  \n  // Match exact\n  if (norm1 === norm2) {\n    console.log(`      ‚Üí Match exact ‚úÖ`);\n    return true;\n  }\n  \n  // L'un contient l'autre\n  if (norm1.includes(norm2) || norm2.includes(norm1)) {\n    console.log(`      ‚Üí Match par inclusion ‚úÖ`);\n    return true;\n  }\n  \n  // Variantes tunisiennes\n  const cityGroups = [\n    ['tunis', 'tounes', 'tunes'],\n    ['tozeur', 'tozer', 'touzeur'],\n    ['sousse', 'soussa', 'sousa'],\n    ['sfax', 'safakes', 'sfekes'],\n    ['gabes', 'qabis'],\n    ['monastir', 'mestir'],\n    ['kairouan', 'kairawan'],\n    ['bizerte', 'banzart'],\n    ['kef', 'elkef', 'lekef'],\n    ['mahdia', 'mehdia']\n  ];\n  \n  for (const group of cityGroups) {\n    const in1 = group.some(v => v === norm1 || norm1.includes(v));\n    const in2 = group.some(v => v === norm2 || norm2.includes(v));\n    if (in1 && in2) {\n      console.log(`      ‚Üí Match par variante tunisienne ‚úÖ`);\n      return true;\n    }\n  }\n  \n  console.log(`      ‚Üí Pas de match ‚ùå`);\n  return false;\n}\n\n// FILTRER LES TRAJETS\nconsole.log(\"\\nüîç ANALYSE D√âTAILL√âE DES TRAJETS:\");\nconsole.log(\"==================================\\n\");\n\nconst foundRides = [];\nconst rejectedRides = [];\n\nfor (let i = 0; i < allRides.length; i++) {\n  const ride = allRides[i].json;\n  \n  // Extraire les infos du trajet\n  const rideDeparture = ride.departure || ride.Departure || '';\n  const rideArrival = ride.arrival || ride.Arrival || '';\n  const rideDate = ride.date || ride.Date || null;\n  \n  console.log(`üìç Trajet ${i + 1}: ${rideDeparture} ‚Üí ${rideArrival}`);\n  console.log(`   Date: ${rideDate || 'non sp√©cifi√©e'}`);\n  console.log(`   Conducteur: ${ride.driver || 'inconnu'}`);\n  \n  // V√©rifier le d√©part\n  console.log(`\\n   üî∏ V√©rification D√âPART:`);\n  const departureOk = citiesMatch(rideDeparture, searchCriteria.departure);\n  \n  // V√©rifier l'arriv√©e\n  console.log(`\\n   üî∏ V√©rification ARRIV√âE:`);\n  const arrivalOk = citiesMatch(rideArrival, searchCriteria.arrival);\n  \n  // V√©rifier la date si sp√©cifi√©e\n  let dateOk = true;\n  if (searchCriteria.date && rideDate) {\n    dateOk = (rideDate === searchCriteria.date);\n    console.log(`\\n   üî∏ V√©rification DATE:`);\n    console.log(`      ${rideDate} vs ${searchCriteria.date} = ${dateOk ? '‚úÖ' : '‚ùå'}`);\n  }\n  \n  // D√©cision finale\n  console.log(`\\n   üìä BILAN:`);\n  console.log(`      - D√©part: ${departureOk ? '‚úÖ' : '‚ùå'}`);\n  console.log(`      - Arriv√©e: ${arrivalOk ? '‚úÖ' : '‚ùå'}`);\n  console.log(`      - Date: ${dateOk ? '‚úÖ' : '‚ùå'}`);\n  \n  if (departureOk && arrivalOk && dateOk) {\n    console.log(`\\n   ‚úÖ‚úÖ‚úÖ TRAJET RETENU ‚úÖ‚úÖ‚úÖ\\n`);\n    foundRides.push(ride);\n  } else {\n    console.log(`\\n   ‚ùå‚ùå‚ùå TRAJET √âCART√â ‚ùå‚ùå‚ùå\\n`);\n    rejectedRides.push(ride);\n  }\n  \n  console.log(\"   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n\");\n}\n\nconsole.log(\"\\nüìä R√âSULTAT FINAL:\");\nconsole.log(`   ‚úÖ Trajets trouv√©s: ${foundRides.length}`);\nconsole.log(`   ‚ùå Trajets √©cart√©s: ${rejectedRides.length}`);\nconsole.log(`   üìã Total analys√©: ${allRides.length}`);\n\n// RETOURNER LE R√âSULTAT\nif (foundRides.length === 0) {\n  // Montrer les trajets disponibles pour debug\n  const availableRoutes = rejectedRides.slice(0, 5).map(r => ({\n    depart: r.departure || r.Departure,\n    arrivee: r.arrival || r.Arrival,\n    date: r.date || r.Date\n  }));\n  \n  return [{\n    json: {\n      success: true,\n      found: false,\n      message: `Aucun trajet trouv√© de ${searchCriteria.departure} vers ${searchCriteria.arrival}`,\n      recherche: searchCriteria,\n      nombre_total_trajets: rejectedRides.length,\n      trajets_disponibles: availableRoutes,\n      conseil: \"V√©rifiez l'orthographe des villes ou essayez une autre route\"\n    }\n  }];\n}\n\n// Retourner uniquement les trajets qui correspondent\nconsole.log(\"\\n‚úÖ Retour des trajets filtr√©s:\");\nfoundRides.forEach((ride, i) => {\n  console.log(`   ${i + 1}. ${ride.departure} ‚Üí ${ride.arrival} (${ride.date})`);\n});\n\nreturn [{\n  json: {\n    success: true,\n    found: true,\n    message: `${foundRides.length} trajet(s) trouv√©(s)`,\n    count: foundRides.length,\n    recherche: searchCriteria,\n    rides: foundRides\n  }\n}];"
      },
      "name": "Filtrer Trajets",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        256,
        32
      ],
      "id": "37c3ad05-8bfb-43d7-a016-98b4388ef00c"
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        464,
        32
      ],
      "id": "33359400-3189-4436-b48e-3b16e37358ba",
      "name": "R√©ponse API"
    },
    {
      "parameters": {
        "model": "llama-3.3-70b-versatile",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -336,
        80
      ],
      "id": "82fc267b-88a6-4380-8891-580ddeeac761",
      "name": "Groq Model",
      "credentials": {
        "groqApi": {
          "id": "tk1Z6r0mfYgcuqLA",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        96,
        368
      ],
      "id": "5ab27769-524a-449a-9e6c-a7bfaa5bfdf8",
      "name": "Merge"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Extraire Infos LLM",
            "type": "main",
            "index": 0
          },
          {
            "node": "Lire Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extraire Infos LLM": {
      "main": [
        [
          {
            "node": "Pr√©parer Crit√®res",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pr√©parer Crit√®res": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lire Google Sheets": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Filtrer Trajets": {
      "main": [
        [
          {
            "node": "R√©ponse API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq Model": {
      "ai_languageModel": [
        [
          {
            "node": "Extraire Infos LLM",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Filtrer Trajets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "b3281b1e86729c6caaa4dd45570bb3f7c8dc6aea653410bcbe83dce4980da848"
  }
}
