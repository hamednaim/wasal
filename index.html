<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaselNy.ai - Covoiturage Intelligent en Tunisie 🚗</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            animation: fadeInDown 1s ease;
        }

        .logo {
            font-size: 3em;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .logo .ai {
            color: #ffd700;
            animation: pulse 2s infinite;
        }

        .tagline {
            color: white;
            font-size: 1.2em;
            opacity: 0.9;
        }

        .container {
            display: flex;
            gap: 30px;
            max-width: 1200px;
            width: 100%;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 350px;
            max-width: 500px;
            animation: fadeInUp 1s ease;
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .card-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .card-title {
            font-size: 1.5em;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .search-box {
            position: relative;
        }

        .search-box textarea {
            padding-right: 50px;
            resize: vertical;
            min-height: 80px;
        }

        .mic-button {
            position: absolute;
            right: 10px;
            top: 35px;
            background: linear-gradient(135deg, #ff6b6b, #ff4757);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            box-shadow: 0 3px 10px rgba(255, 71, 87, 0.3);
        }

        .mic-button:hover {
            background: linear-gradient(135deg, #ff4757, #ff3838);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.4);
        }

        .mic-button.recording {
            animation: recordPulse 1s infinite;
            background: linear-gradient(135deg, #ff0000, #cc0000);
        }

        .mic-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .results {
            margin-top: 30px;
            padding: 30px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            display: none;
            max-width: 1200px;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .results.show {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .close-results {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 300;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .close-results:hover {
            background: #fff;
            color: #333;
            border-color: #999;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .result-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .driver-name {
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }

        .price {
            background: #4caf50;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .price.no-price {
            background: #ff9800;
        }

        .route {
            color: #666;
            margin: 5px 0;
        }

        .comment-box {
            display: inline-block;
            background: #fff3cd;
            padding: 8px 12px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 3px solid #ffc107;
            font-style: italic;
            color: #856404;
            font-size: 0.95em;
        }

        .contact-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .contact-btn {
            background: #25d366;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            flex: 0 0 auto;
            min-width: 120px;
        }

        .contact-btn:hover {
            background: #128c7e;
            transform: scale(1.05);
        }

        .contact-btn.call {
            background: #2196f3;
        }

        .contact-btn.call:hover {
            background: #1976d2;
        }

        .contact-btn.copy {
            background: #9c27b0;
        }

        .contact-btn.copy:hover {
            background: #7b1fa2;
        }

        .contact-btn.copy.copied {
            background: #4caf50;
        }

        .success-message {
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .success-message.show {
            display: block;
        }

        .error-message {
            background: #f44336;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .error-message.show {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .cities-suggestion {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .city-chip {
            background: #e9ecef;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.85em;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .city-chip:hover {
            background: #667eea;
            color: white;
        }

        .admin-link {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .admin-link:hover {
            background: white;
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .mode-switch-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            animation: fadeInDown 1.2s ease;
        }

        .mode-switch {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .mode-option {
            padding: 14px 30px;
            border-radius: 46px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
            border: none;
            background: transparent;
            position: relative;
            z-index: 1;
        }

        .mode-option:hover:not(.active) {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }

        .mode-option.active {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15), 0 2px 8px rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .mode-option .icon {
            font-size: 1.2em;
        }

        .card.hidden {
            display: none;
        }

        .card.show {
            display: block;
            animation: fadeInUp 0.6s ease;
        }

        .email-info-container {
            position: relative;
            display: inline-block;
            margin-left: 5px;
        }

        .email-info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            cursor: help;
            vertical-align: middle;
        }

        .email-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.85em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 100;
            max-width: 250px;
            white-space: normal;
            margin-bottom: 5px;
        }

        .email-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
        }

        .email-info-container:hover .email-tooltip {
            opacity: 1;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes recordPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .card {
                min-width: 100%;
            }

            .logo {
                font-size: 2em;
            }

            .admin-link {
                bottom: 10px;
                right: 10px;
                font-size: 0.9em;
            }

            .mode-switch {
                padding: 4px;
            }

            .mode-option {
                padding: 12px 24px;
                font-size: 0.9em;
            }

            .mode-option .icon {
                font-size: 1.1em;
            }

            .tagline {
                font-size: 1em;
            }

            .contact-buttons {
                flex-direction: row;
                justify-content: space-between;
            }

            .contact-btn {
                flex: 1;
                min-width: auto;
                padding: 10px 12px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">Wasel<span class="ai">Ny.ai</span> 🚗</div>
        <div class="tagline">Covoiturage intelligent partout en Tunisie</div>
    </div>

    <!-- Switch pour choisir le mode -->
    <div class="mode-switch-container">
        <div class="mode-switch">
            <button class="mode-option active" id="clientMode" onclick="switchMode('client')">
                <span class="icon">🔍</span>
                <span>Chercher un trajet</span>
            </button>
            <button class="mode-option" id="driverMode" onclick="switchMode('driver')">
                <span class="icon">🚘</span>
                <span>Proposer un trajet</span>
            </button>
        </div>
    </div>

    <div class="container">
        <!-- Carte Chauffeur -->
        <div class="card hidden" id="driverCard">
            <div class="card-header">
                <div class="card-icon">🚘</div>
                <div class="card-title">Je propose un trajet</div>
            </div>
            
            <form id="driverForm">
                <div class="form-group">
                    <label>Nom complet</label>
                    <input type="text" name="nom" placeholder="Mohamed Ben Ali" required>
                </div>

                <div class="form-group">
                    <label>
                        Email
                        <span class="email-info-container">
                            <span class="email-info-icon">?</span>
                            <span class="email-tooltip">Email de gestion pour modifier ou supprimer votre trajet ultérieurement</span>
                        </span>
                    </label>
                    <input type="email" name="email" placeholder="votre.email@example.com" required>
                </div>

                <div class="form-group">
                    <label>Numéro de téléphone</label>
                    <input type="tel" name="telephone" placeholder="98 765 432" required>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Ville de départ</label>
                        <input type="text" name="depart" placeholder="Tunis" autocomplete="off" required>
                        <div class="cities-suggestion">
                            <span class="city-chip" onclick="setCity(this, 'depart')">Tunis</span>
                            <span class="city-chip" onclick="setCity(this, 'depart')">Sfax</span>
                            <span class="city-chip" onclick="setCity(this, 'depart')">Sousse</span>
                            <span class="city-chip" onclick="setCity(this, 'depart')">Bizerte</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Ville d'arrivée</label>
                        <input type="text" name="arrivee" placeholder="Sousse" autocomplete="off" required>
                        <div class="cities-suggestion">
                            <span class="city-chip" onclick="setCity(this, 'arrivee')">Gabès</span>
                            <span class="city-chip" onclick="setCity(this, 'arrivee')">Tozeur</span>
                            <span class="city-chip" onclick="setCity(this, 'arrivee')">Monastir</span>
                            <span class="city-chip" onclick="setCity(this, 'arrivee')">Nabeul</span>
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Date</label>
                        <input type="date" name="date" required>
                    </div>
                    <div class="form-group">
                        <label>Heure</label>
                        <input type="time" name="heure" value="11:00" required>
                    </div>
                </div>

                <div class="input-group">
                    <div class="form-group">
                        <label>Places disponibles</label>
                        <select name="places" required>
                            <option value="1">1 place</option>
                            <option value="2">2 places</option>
                            <option value="3">3 places</option>
                            <option value="4">4 places</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prix par place (DT)</label>
                        <input type="number" name="prix" placeholder="25" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Commentaire (optionnel)</label>
                    <textarea name="commentaire" placeholder="Départ depuis Lac 2, musique autorisée, bagages ok..."></textarea>
                </div>

                <button type="submit">
                    ✨ Publier mon trajet
                </button>

                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Publication en cours...</p>
                </div>

                <div class="success-message" id="driverSuccess">
                    ✅ Trajet publié avec succès ! Les clients peuvent maintenant vous contacter.
                </div>

                <div class="error-message" id="driverError">
                    ❌ Erreur lors de la publication. Veuillez réessayer.
                </div>
            </form>
        </div>

        <!-- Carte Client -->
        <div class="card show" id="clientCard">
            <div class="card-header">
                <div class="card-icon">🔍</div>
                <div class="card-title">Je cherche un trajet</div>
            </div>
            
            <form id="clientForm">
                <div class="form-group search-box">
                    <label>Décrivez votre trajet (en français ou dialecte)</label>
                    <textarea name="recherche" id="searchInput" placeholder="Exemple: bech nemchi ghoudwa l sousse min tunis&#10;ou: Je cherche un trajet Tunis-Sfax pour demain&#10;ou: نحب نمشي لتوزر الجمعة الجاية" required></textarea>
                    <button type="button" class="mic-button" id="micButton" onclick="toggleRecording()">
                        <svg viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                    </button>
                </div>

                <button type="submit">
                    🔍 Rechercher des trajets
                </button>

                <div class="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 10px; color: #666;">Recherche en cours avec l'IA...</p>
                </div>

                <div class="error-message" id="clientError">
                    ❌ Erreur lors de la recherche. Veuillez réessayer.
                </div>
            </form>
        </div>
    </div>

    <!-- Zone de résultats commune - en dehors des cartes -->
    <div class="results" id="searchResults">
        <button class="close-results" onclick="closeResults()">×</button>
        <div id="resultsList"></div>
    </div>

    <!-- Lien contact admin -->
    <a href="mailto:admin@email.tlig?subject=WaselNy.ai - Contact Admin" class="admin-link">
        ✉️ Contacter Admin
    </a>

    <script>
        // Configuration avec vos URLs réelles
        const DRIVER_WEBHOOK = 'https://naimhamed.ddns.net/webhook/ajouter-trajet';
        const CLIENT_WEBHOOK = 'https://naimhamed.ddns.net/webhook/chercher-trajet';

        // Liste des villes tunisiennes pour validation et autocomplete
        const VILLES_TUNISIENNES = [
            'Tunis', 'Sfax', 'Sousse', 'Gabès', 'Bizerte', 'Kairouan', 
            'Gafsa', 'Monastir', 'Ben Arous', 'Kasserine', 'Médenine', 
            'Nabeul', 'Tataouine', 'Béja', 'Jendouba', 'Mahdia', 
            'Sidi Bouzid', 'Tozeur', 'Siliana', 'Kebili', 'Ariana', 
            'Manouba', 'Zaghouan', 'Kef'
        ];

        // Fonction d'autocomplete personnalisée
        function setupAutocomplete() {
            const inputs = document.querySelectorAll('input[name="depart"], input[name="arrivee"]');
            
            inputs.forEach(input => {
                let currentFocus = -1;
                
                input.addEventListener('input', function() {
                    const val = this.value;
                    closeAllLists();
                    if (!val) return false;
                    
                    currentFocus = -1;
                    const list = document.createElement('div');
                    list.setAttribute('id', this.id + '-autocomplete-list');
                    list.setAttribute('class', 'autocomplete-items');
                    list.style.cssText = `
                        position: absolute;
                        border: 1px solid #d4d4d4;
                        border-bottom: none;
                        border-top: none;
                        z-index: 99;
                        top: 100%;
                        left: 0;
                        right: 0;
                        background: white;
                        border-radius: 0 0 10px 10px;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                        max-height: 200px;
                        overflow-y: auto;
                    `;
                    this.parentNode.appendChild(list);
                    
                    let hasMatch = false;
                    VILLES_TUNISIENNES.forEach(ville => {
                        if (ville.substr(0, val.length).toUpperCase() === val.toUpperCase()) {
                            hasMatch = true;
                            const item = document.createElement('div');
                            item.style.cssText = `
                                padding: 10px;
                                cursor: pointer;
                                border-bottom: 1px solid #eee;
                                transition: background 0.2s;
                            `;
                            item.innerHTML = `<strong>${ville.substr(0, val.length)}</strong>${ville.substr(val.length)}`;
                            item.addEventListener('click', function() {
                                input.value = ville;
                                closeAllLists();
                                validateCity(input);
                            });
                            item.addEventListener('mouseover', function() {
                                this.style.background = '#e9ecef';
                            });
                            item.addEventListener('mouseout', function() {
                                this.style.background = 'white';
                            });
                            list.appendChild(item);
                        }
                    });
                    
                    if (!hasMatch) {
                        const noMatch = document.createElement('div');
                        noMatch.style.cssText = `
                            padding: 10px;
                            color: #999;
                            font-style: italic;
                        `;
                        noMatch.textContent = 'Aucune ville correspondante';
                        list.appendChild(noMatch);
                    }
                });
                
                function closeAllLists(elmnt) {
                    const items = document.getElementsByClassName('autocomplete-items');
                    for (let i = 0; i < items.length; i++) {
                        if (elmnt !== items[i] && elmnt !== input) {
                            items[i].parentNode.removeChild(items[i]);
                        }
                    }
                }
                
                document.addEventListener('click', function (e) {
                    closeAllLists(e.target);
                });
            });
        }

        // Fonction pour fermer les résultats
        function closeResults() {
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.classList.remove('show');
        }

        // Validation des villes tunisiennes
        function validateCity(input) {
            const city = input.value.trim();
            const isValid = VILLES_TUNISIENNES.some(v => 
                v.toLowerCase() === city.toLowerCase()
            );
            
            if (!isValid && city !== '') {
                input.setCustomValidity('Veuillez sélectionner une ville tunisienne valide');
                input.style.borderColor = '#f44336';
            } else {
                input.setCustomValidity('');
                input.style.borderColor = '';
            }
            return isValid;
        }

        // Initialiser l'autocomplete au chargement
        document.addEventListener('DOMContentLoaded', () => {
            setupAutocomplete();
            
            const villeInputs = document.querySelectorAll('input[name="depart"], input[name="arrivee"]');
            villeInputs.forEach(input => {
                input.addEventListener('blur', () => {
                    setTimeout(() => validateCity(input), 200);
                });
            });
        });

        // Gestion du formulaire chauffeur
        document.getElementById('driverForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const rawData = Object.fromEntries(formData);
            
            // 🎯 MAPPING vers les noms de colonnes Google Sheet
            const data = {
                driver: rawData.nom,           
                phone: rawData.telephone,      
                email: rawData.email,          // Nouveau champ email
                departure: rawData.depart,     
                arrival: rawData.arrivee,      
                date: rawData.date,            
                time: rawData.heure,           
                seats: rawData.places,         
                price: rawData.prix,           
                comment: rawData.commentaire   
            };
            
            // Cacher les messages précédents
            document.getElementById('driverSuccess').classList.remove('show');
            document.getElementById('driverError').classList.remove('show');
            
            // Valider les villes avant l'envoi
            const departInput = e.target.querySelector('input[name="depart"]');
            const arriveeInput = e.target.querySelector('input[name="arrivee"]');
            
            if (!validateCity(departInput) || !validateCity(arriveeInput)) {
                alert('Veuillez sélectionner des villes tunisiennes valides');
                return;
            }
            
            // Afficher le loading
            e.target.querySelector('.loading').classList.add('show');
            e.target.querySelector('button[type="submit"]').disabled = true;
            
            try {
                console.log('Données mappées pour Google Sheet:', data);
                
                const response = await fetch(DRIVER_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                console.log('Réponse status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Réponse:', result);
                    
                    // Afficher le succès
                    document.getElementById('driverSuccess').classList.add('show');
                    e.target.reset();
                    
                    // Réinitialiser la date et l'heure
                    const dateInput = e.target.querySelector('input[type="date"]');
                    const timeInput = e.target.querySelector('input[type="time"]');
                    const today = new Date().toISOString().split('T')[0];
                    dateInput.value = today;
                    timeInput.value = '11:00'; // Remettre l'heure par défaut
                    
                    // Cacher le message après 5 secondes
                    setTimeout(() => {
                        document.getElementById('driverSuccess').classList.remove('show');
                    }, 5000);
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('driverError').classList.add('show');
                setTimeout(() => {
                    document.getElementById('driverError').classList.remove('show');
                }, 5000);
            } finally {
                e.target.querySelector('.loading').classList.remove('show');
                e.target.querySelector('button[type="submit"]').disabled = false;
            }
        });

        // Gestion du formulaire client
        document.getElementById('clientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const recherche = document.getElementById('searchInput').value;
            
            // Cacher les messages d'erreur
            document.getElementById('clientError').classList.remove('show');
            
            // Afficher le loading
            e.target.querySelector('.loading').classList.add('show');
            e.target.querySelector('button[type="submit"]').disabled = true;
            
            try {
                console.log('Recherche:', recherche);
                
                const response = await fetch(CLIENT_WEBHOOK, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ recherche })
                });
                
                console.log('Réponse status:', response.status);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Résultats:', result);
                    displayResults(result);
                } else {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                document.getElementById('clientError').classList.add('show');
                setTimeout(() => {
                    document.getElementById('clientError').classList.remove('show');
                }, 5000);
            } finally {
                e.target.querySelector('.loading').classList.remove('show');
                e.target.querySelector('button[type="submit"]').disabled = false;
            }
        });

        // Fonction pour copier le numéro de téléphone
        function copyPhone(phone, button) {
            navigator.clipboard.writeText(phone).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '✅ Copié !';
                button.classList.add('copied');
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Erreur lors de la copie:', err);
                alert('Numéro: ' + phone);
            });
        }

        // Affichage des résultats de recherche - AMÉLIORÉ
        function displayResults(data) {
            const resultsDiv = document.getElementById('searchResults');
            const resultsList = document.getElementById('resultsList');
            
            console.log('Données reçues:', data);
            
            let html = '';
            
            // Nouveau format avec propriété 'rides'
            if (data.rides && Array.isArray(data.rides) && data.rides.length > 0) {
                // Afficher les informations de recherche
                if (data.recherche) {
                    html += `
                        <div class="search-info">
                            <div class="search-details">
                                🎯 Recherche: ${data.recherche.departure || ''} → ${data.recherche.arrival || ''}
                                ${data.recherche.date ? ` le ${data.recherche.date}` : ''}
                            </div>
                        </div>
                    `;
                }
                
                // Afficher le compteur de résultats
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: #333;">Trajets disponibles 🎯</h3>
                        <span class="results-count">${data.count || data.rides.length} trajet(s)</span>
                    </div>
                `;
                
                // Afficher chaque trajet
                data.rides.forEach(ride => {
                    const phoneClean = ride.phone.replace(/\s/g, '');
                    const priceDisplay = ride.price ? `${ride.price} DT` : 'Contacter pour prix';
                    const priceClass = ride.price ? 'price' : 'price no-price';
                    
                    html += `
                        <div class="result-item">
                            <div class="result-header">
                                <span class="driver-name">👤 ${ride.driver}</span>
                                <span class="${priceClass}">${priceDisplay}</span>
                            </div>
                            <div class="route">
                                📍 ${ride.departure} → ${ride.arrival}
                            </div>
                            <div class="route">
                                📅 ${formatDate(ride.date)}${ride.time ? ' à ' + ride.time : ''}
                            </div>
                            ${ride.seats ? `
                                <div class="route">
                                    💺 ${ride.seats} place(s) disponible(s)
                                </div>
                            ` : ''}
                            ${ride.comment ? `
                                <div style="margin: 10px 0;">
                                    <span class="comment-box">💬 ${ride.comment}</span>
                                </div>
                            ` : ''}
                            <div class="contact-buttons">
                                <a href="https://wa.me/216${phoneClean}?text=Bonjour, je suis intéressé par votre trajet ${ride.departure} - ${ride.arrival} du ${formatDate(ride.date)}" 
                                   class="contact-btn" target="_blank">
                                    💬 WhatsApp
                                </a>
                                <a href="tel:+216${phoneClean}" 
                                   class="contact-btn call">
                                    📞 Appeler
                                </a>
                                <button onclick="copyPhone('${phoneClean}', this)" 
                                        class="contact-btn copy">
                                    📋 Copier numéro
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            // Aucun trajet trouvé
            else {
                html += `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p style="font-size: 2em;">😔</p>
                        <p><strong>Aucun trajet trouvé</strong></p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            ${data.message || 'Essayez avec d\'autres dates ou villes.'}
                        </p>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 0.9em;">
                            <p>💡 <strong>Conseils:</strong></p>
                            <ul style="text-align: left; margin-top: 10px; line-height: 1.6;">
                                <li>Essayez des villes proches</li>
                                <li>Modifiez légèrement vos dates</li>
                                <li>Utilisez des noms de villes en français ou arabe</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
            
            // Afficher le message personnalisé de l'API si disponible
            if (data.message && data.rides && data.rides.length > 0) {
                html = `
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                        <p style="color: #2e7d32; font-weight: 600;">✅ ${data.message}</p>
                    </div>
                ` + html;
            }
            
            resultsList.innerHTML = html;
            resultsDiv.classList.add('show');
        }

        // Fonction utilitaire pour formater les dates
        function formatDate(dateString) {
            if (!dateString) return 'Date non spécifiée';
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return dateString; // Retourner la chaîne originale en cas d'erreur
            }
        }

        // Fonction pour remplir les villes
        function setCity(chip, inputName) {
            const input = document.querySelector(`input[name="${inputName}"]`);
            input.value = chip.textContent;
        }

        // Reconnaissance vocale (améliorée)
        let recognition;
        let isRecording = false;

        function toggleRecording() {
            const micButton = document.getElementById('micButton');
            const searchInput = document.getElementById('searchInput');
            
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                alert('Votre navigateur ne supporte pas la reconnaissance vocale.');
                return;
            }
            
            if (!recognition) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'ar-TN';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    searchInput.value = transcript;
                    stopRecording();
                };
                
                recognition.onerror = (event) => {
                    console.error('Erreur reconnaissance vocale:', event.error);
                    stopRecording();
                };
                
                recognition.onend = () => {
                    stopRecording();
                };
            }
            
            if (!isRecording) {
                recognition.start();
                isRecording = true;
                micButton.classList.add('recording');
                micButton.innerHTML = `
                    <svg viewBox="0 0 24 24">
                        <rect x="9" y="9" width="6" height="6" rx="1"/>
                    </svg>
                `;
            } else {
                stopRecording();
            }
        }

        function stopRecording() {
            const micButton = document.getElementById('micButton');
            if (recognition) {
                recognition.stop();
            }
            isRecording = false;
            micButton.classList.remove('recording');
            micButton.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            `;
        }

        // Définir la date minimum à aujourd'hui
        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.querySelector('input[type="date"]');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = today;
                dateInput.value = today;
            }
            
            // Définir l'heure par défaut à 11:00
            const timeInput = document.querySelector('input[type="time"]');
            if (timeInput && !timeInput.value) {
                timeInput.value = '11:00';
            }
        });

        // Test de connexion au chargement
        console.log('WaselNy.ai chargé !');
        console.log('Webhook Chauffeur:', DRIVER_WEBHOOK);
        console.log('Webhook Client:', CLIENT_WEBHOOK);

        // Fonction pour switcher entre les modes
        function switchMode(mode) {
            const clientCard = document.getElementById('clientCard');
            const driverCard = document.getElementById('driverCard');
            const clientModeBtn = document.getElementById('clientMode');
            const driverModeBtn = document.getElementById('driverMode');
            
            // Réinitialiser les classes active
            clientModeBtn.classList.remove('active');
            driverModeBtn.classList.remove('active');
            
            // Masquer toutes les cartes
            clientCard.classList.remove('show');
            driverCard.classList.remove('show');
            clientCard.classList.add('hidden');
            driverCard.classList.add('hidden');
            
            if (mode === 'client') {
                // Afficher la carte client
                setTimeout(() => {
                    clientCard.classList.remove('hidden');
                    clientCard.classList.add('show');
                }, 100);
                clientModeBtn.classList.add('active');
                
            } else if (mode === 'driver') {
                // Afficher la carte chauffeur
                setTimeout(() => {
                    driverCard.classList.remove('hidden');
                    driverCard.classList.add('show');
                }, 100);
                driverModeBtn.classList.add('active');
            }
            
            // Masquer seulement les messages d'erreur et de succès
            document.querySelectorAll('.error-message, .success-message').forEach(msg => {
                msg.classList.remove('show');
            });
            
            console.log(`Mode basculé vers: ${mode} - Résultats conservés`);
        }

        // Initialiser avec le mode client par défaut
        document.addEventListener('DOMContentLoaded', () => {
            switchMode('client');
        });
    </script>
</body>
</html>
